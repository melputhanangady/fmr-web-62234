rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions for validation
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidUserData() {
      return request.resource.data.keys().hasAll(['name', 'age', 'bio', 'city', 'interests', 'photos', 'preferences', 'likedUsers', 'passedUsers', 'matches', 'createdAt']) &&
             request.resource.data.name is string &&
             request.resource.data.name.size() >= 2 &&
             request.resource.data.name.size() <= 50 &&
             request.resource.data.age is int &&
             request.resource.data.age >= 18 &&
             request.resource.data.age <= 100 &&
             request.resource.data.bio is string &&
             request.resource.data.bio.size() >= 10 &&
             request.resource.data.bio.size() <= 500 &&
             request.resource.data.city is string &&
             request.resource.data.city.size() >= 2 &&
             request.resource.data.city.size() <= 50 &&
             request.resource.data.interests is list &&
             request.resource.data.interests.size() >= 1 &&
             request.resource.data.interests.size() <= 10 &&
             request.resource.data.photos is list &&
             request.resource.data.photos.size() <= 6 &&
             request.resource.data.preferences is map &&
             request.resource.data.likedUsers is list &&
             request.resource.data.passedUsers is list &&
             request.resource.data.matches is list &&
             request.resource.data.createdAt is timestamp;
    }
    
    function isValidPreferences() {
      return request.resource.data.preferences.keys().hasAll(['minAge', 'maxAge', 'interestedIn', 'cities']) &&
             request.resource.data.preferences.minAge is int &&
             request.resource.data.preferences.minAge >= 18 &&
             request.resource.data.preferences.minAge <= 100 &&
             request.resource.data.preferences.maxAge is int &&
             request.resource.data.preferences.maxAge >= 18 &&
             request.resource.data.preferences.maxAge <= 100 &&
             request.resource.data.preferences.minAge <= request.resource.data.preferences.maxAge &&
             request.resource.data.preferences.interestedIn in ['men', 'women', 'both'] &&
             request.resource.data.preferences.cities is list &&
             request.resource.data.preferences.cities.size() <= 5;
    }
    
    
    function isValidMessage() {
      return request.resource.data.keys().hasAll(['senderId', 'text', 'timestamp', 'read']) &&
             request.resource.data.senderId is string &&
             request.resource.data.text is string &&
             request.resource.data.text.size() >= 1 &&
             request.resource.data.text.size() <= 1000 &&
             request.resource.data.timestamp is timestamp &&
             request.resource.data.read is bool;
    }
    
    
    // Users collection rules
    match /users/{userId} {
      // Users can read their own profile
      allow read: if isOwner(userId);
      
      // Users can read other users' profiles for matching
      allow read: if isAuthenticated();
      
      // Users can create their own profile
      allow create: if isOwner(userId);
      
      // Users can update their own profile
      // Allow all updates for debugging purposes
      allow update: if isAuthenticated();
      
      // Users can delete their own profile
      allow delete: if isOwner(userId);
    }
    
    // Matches collection rules
    match /matches/{matchId} {
      // Users can read matches they're part of
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.users;
      
      // Users can create matches they're part of
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.users;
      
      // Users can update matches they're part of (for future features)
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.users;
      
      // Users can delete matches they're part of
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.users;
    }
    
    // Allow querying matches collection for debugging purposes
    match /matches/{matchId} {
      // Allow authenticated users to query matches collection
      allow list: if isAuthenticated();
    }
    
    // Messages subcollection rules
    match /messages/{matchId}/messages/{messageId} {
      // Users can read messages in matches they're part of
      allow read: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users;
      
      // Users can create messages in matches they're part of
      allow create: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
        isValidMessage() &&
        request.resource.data.senderId == request.auth.uid;
      
      // Users can update read status of messages
      allow update: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/matches/$(matchId)).data.users &&
        request.resource.data.keys().hasOnly(['read']) &&
        request.resource.data.read is bool;
    }
    
    // Admin collection (for future admin features)
    match /admin/{document=**} {
      // Only allow admin access (implement admin role checking)
      allow read, write: if false; // Disabled for now
    }
    
    // Reports collection (for user reporting)
    match /reports/{reportId} {
      allow create: if isAuthenticated() && 
        request.resource.data.keys().hasAll(['reporterId', 'reportedUserId', 'reason', 'timestamp']) &&
        request.resource.data.reporterId == request.auth.uid &&
        request.resource.data.reportedUserId is string &&
        request.resource.data.reason is string &&
        request.resource.data.timestamp is timestamp;
      
      allow read: if false; // Only admins should read reports
    }
    
    // Analytics collection (for app analytics)
    match /analytics/{document=**} {
      allow write: if isAuthenticated(); // Allow users to write analytics events
      allow read: if false; // Only admins should read analytics
    }
  }
}